<!--
    This file contains the layout and logic for playing the game
-->
<script type="text/javascript">
    // This script should be included in all content pages!
    // REMEMBER TO CHANGE THE CONTENT NAME!
    var contentName = "play";
    console.debug("--- BEGIN (" + contentName + ") ---");
    setCookie("action", contentName);
</script>
<!--  -->
<div class="row">
    <div class="col-md-1">
        <br />
        <div style="display:inline;float:left">
            <span id="chart-question" class="chart chart-single" data-percent="0">
            </span>
        </div>
    </div>
    <div class="col-md-10">
        <div class="jumbotron">
            <h2 id="questionTxt" class="text-center">QuiZZam!</h2>
        </div>
        <div id="alternativesDiv" class="row">
            <!-- Buttons are generated by each question-->
        </div>
    </div>
    <div id="XscoreboardDiv" class="col-md-1">
        <!-- Scoreboard loaded through jQuery -->
    </div>
</div>

<script type="text/javascript">

    var qID
    //var lginterval
    var questionID = "noQuestion";
    var numberOfAlternatives = 0;

    var clickedOffset = "";
    //var hasAnswered = false;

    $(document).ready(function () {
        console.debug("Page loaded");
        qID = getCookie("quizz");
        //lginterval = setInterval(loadGame, 900); //Start reloading every 900 ms
        loadGame();
    });
    
    $(function () {
        console.debug("Pie!");
        $('#chart-question').easyPieChart({
            barColor: '#03A9F4',
            easing: 'easeOutSine',
            lineCap: 'butt',
            trackColor: '#f2f2f2',
            scaleColor: '#dfe0e0',
            scaleLength: 5,
            size: 90,
            lineWidth: 16,
            animate: false,
            onStep: function (from, to, percent) {
                $(this.el).find('.percent').text(Math.round(percent));
            }
        });
    })

    function loadGame() {
        var reloadTime = 750;
        console.debug("Loading game " + qID);
        $.get("rest/quizzgames/" + qID, function (data, status) {
            console.debug("Game status: " + data.status);
            if (data.status != "active") {
                $('#chart-question').hide();
                $('#alternativesDiv').empty();
            }
            switch (data.status) {
                case "later":
                    $('#questionTxt').text("The quiz won't start for a while yet. Come back later...");
                    reloadTime = 60000;
                    break;

                case "soon":
                    if (data.remainingTime > 60) {
                        $('#questionTxt').text("The quiz will start within two minutes... Get ready!");
                        reloadTime =  10000;
                        break;
                    }
                    if (data.remainingTime < 60  && data.remainingTime > 30) {
                        $('#questionTxt').text("Less than a minute to go!");
                        reloadTime = 5000;
                        break;
                    }
                    if (data.remainingTime <= 30 && data.remainingTime > 10) {
                        $('#questionTxt').text("Thirty seconds and counting!");
                        reloadTime = 2000;
                        break;
                    }
                    if (data.remainingTime <= 10) {
                        $('#questionTxt').text("Starting in " + data.remainingTime + "...");
                        break;
                    }

                case "active":
                    //reloadTime = 0;
                    console.debug("Game is active!");
                    console.debug(data.currentQuestion);
                    console.debug(data.currentQuestion.id + "!==" + questionID);
                    

                    if (data.currentQuestion != null) {
                        // Get the time remaining for this question, and update the timer.
                        $('#chart-question').show();
                        var timePercentage = (data.remainingTime + 1) / data.currentQuestion.secondsAllotted * 100;
                        //console.debug(data.remainingTime + '/' + data.currentQuestion.secondsAllotted + '=' + timePercentage);
                        $('#chart-question').data('easyPieChart').update(timePercentage);

                        if (data.currentQuestion.id !== questionID) { // Is this a new question?
                            questionID=data.currentQuestion.id;
                            if (data.currentQuestion.questionText != "") {
                                // Display the question and the alternatives
                                $('#questionTxt').text(data.currentQuestion.questionText)
                                $('#alternativesDiv').empty();
                                numberOfAlternatives = data.currentQuestion.alternatives.length;
                                var buttonSize = "col-md-1";
                                var offset = "";
                                switch (numberOfAlternatives) {
                                    case 1:
                                        buttonSize = "col-md-4";
                                        offset = "col-md-offset-4";
                                        break;
                                    case 2:
                                        buttonSize = "col-md-4";
                                        offset = "col-md-offset-2";
                                        clickedOffset = "col-md-offset-4";
                                        break;
                                    case 3:
                                        buttonSize = "col-md-4";
                                        clickedOffset = "col-md-offset-4";
                                        break;
                                    case 4:
                                        buttonSize = "col-md-3";
                                        clickedOffset = "col-md-offset-4";
                                        break;
                                    case 5:
                                        buttonSize = "col-md-2";
                                        offset = "col-md-offset-1";
                                        clickedOffset = "col-md-offset-5";
                                        break;
                                    case 6:
                                        buttonSize = "col-md-2";
                                        break;
                                    case 7:
                                        buttonSize = "col-md-1";
                                        offset = "col-md-offset-2";
                                        clickedOffset = "col-md-offset-5";
                                        break;
                                    case 8:
                                        buttonSize = "col-md-1";
                                        offset = "col-md-offset-2";
                                        clickedOffset = "col-md-offset-5";
                                        break;
                                    case 9:
                                        buttonSize = "col-md-1";
                                        offset = "col-md-offset-5";
                                        break;
                                    case 10:
                                        buttonSize = "col-md-1";
                                        offset = "col-md-offset-1";
                                        break;
                                    case 11:
                                        buttonSize = "col-md-1";
                                        break;
                                    default:

                                }
                                
                                for (i = 0; i < numberOfAlternatives; i++) {
                                    var newAlternative = '';
                                    if (i != 0) {
                                        offset = ""
                                    }
                                    newAlternative += '<div id="alt_' + i + '" onClick="selectAlternative(' + i + ')" class="' + buttonSize + ' ' + offset + '" Xstyle="display:inline-block;">';
                                    newAlternative += '    <div class="panel-group">';
                                    newAlternative += '        <div class="panel panel-' + getLook(i % 4) + '">';
                                    newAlternative += '            <div class="panel-heading">' + i + '</div>';
                                    newAlternative += '            <div class="answerbutton panel-body">' + data.currentQuestion.alternatives[i] + '</div>';
                                    newAlternative += '        </div>';
                                    newAlternative += '    </div>';
                                    newAlternative += '</div>';
                                    $('#alternativesDiv').append(newAlternative);
                                    newItem = '#alt_' + i;
                                    $(newItem).show();
                                }
                            }                                               
                        }
                    } else {
                        //Quiz is missing critical data!
                        $('#questionTxt').text("Uhm... There seems to be something wrong!");
                        $('#alternativesDiv').empty();
                        reloadTime = 2000;
                    }
                    break;

                case "done":
                    $('#questionTxt').text("The End");
                    reloadTime = 0;
                    loadScoreboard(data.scoreboard.id);
                    break;

                case "error":
                case undefined:
                case null:
                    $('#questionTxt').text("Uh oh! There is something wrong!");
                    reloadTime = 0;
                    break;
            }
            if (reloadTime > 0) {
                console.debug("Reloading page in " + reloadTime + "ms.");
                setTimeout(loadGame, reloadTime);
            }
        });
    }

    function loadScoreboard(bID) {
        console.debug("Loading Scoreboard " + bID);
        $.get("rest/scoreboards/" + bID, function (data, status) {
            for (i = 0; i < data.scores.length; i++) {
                console.debug("Processing score line " + i);
                var nickname = getNickFor(data.scores[i][0]);
                var newAlternative = '';
                if (data.scores[i][0] == null) {
                    return;
                }
                newAlternative += '<div id="alt_' + i + '" onClick="selectAlternative(' + i + ')" class="' + 'col-md-3' + '">';
                newAlternative += '    <div class="panel-group">';
                newAlternative += '        <div class="panel panel-' + getLook(i % 4) + '">';
                newAlternative += '            <div id="nick_' + data.scores[i][0] + '" class="panel-heading"></div>';
                newAlternative += '            <div class="answerbutton panel-body">' + data.scores[i][1] + '</div>';
                newAlternative += '        </div>';
                newAlternative += '    </div>';
                newAlternative += '</div>';
                $('#alternativesDiv').append(newAlternative);
            }
        })
    };

    function getNickFor(playerID) {
        $.get("rest/players/" + playerID, function (data, status) {
            $('#nick_' + playerID).text(data.nick);
        })
    };

    function selectAlternative(alt) {
        console.debug("Selected " + alt);
        aID = uuidv4();
        pID = getCookie("playerID");
        $.ajax({
            url: 'rest/answers',
            type: 'POST',
            data: JSON.stringify({
                id: aID,
                questionID: questionID,
                gameID: qID,
                playerID: pID,
                answerAlt: alt
            }),
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            success: function (result) {
                //TODO: Some fancy animation or cheesy text while waiting for the next question.
                for (i = 0; i < numberOfAlternatives; i++) {
                    if (i != alt) {
                        $("#alt_" + i).addClass('invisible'); //hide(500);
                        //$("#alt_" + i).addClass('invisible'); //hide(500);
                    }
                }
            }
        });
    }

    function getLook(lNum) {
        //console.debug("Looking up look for " + lNum);
        switch (lNum) {
            case 0:
                return 'info';
            case 1:
                return 'warning';
            case 2:
                return 'success';
            case 3:
                return 'danger';
        };
        return 'unknown';
    }
  
</script>